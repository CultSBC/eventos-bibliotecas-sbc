<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Eventos - Bibliotecas SBC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .gradient-header {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .gradient-button {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .gradient-button:hover {
            background: linear-gradient(to right, #1d4ed8, #1e40af);
        }
        .rainbow-bar {
            background: linear-gradient(to bottom, #fb923c, #fbbf24, #4ade80);
        }
        .checkbox-custom {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .logo-header {
            max-height: 70px;
            width: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-orange-50 min-h-screen">
    
    <!-- Header com Logo -->
    <div class="gradient-header text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1">
                    <div class="w-1 h-16 rainbow-bar rounded-full"></div>
                    <div>
                        <h1 class="text-3xl font-bold">Sistema de Eventos Culturais</h1>
                        <p class="text-blue-100 mt-1">Rede de Bibliotecas P√∫blicas Municipais de S√£o Bernardo do Campo</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <img id="logoHeader" class="logo-header" alt="Logo SBC" style="display: none;">
                    <button id="btnConfigurar" onclick="abrirConfiguracao()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition-all text-sm font-medium">
                        ‚öôÔ∏è Configurar Google Sheets
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div id="modalConfiguracao" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Configura√ß√£o do Google Sheets</h2>
                <button onclick="fecharConfiguracao()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-bold text-blue-900 mb-2">üìã Instru√ß√µes:</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-blue-800">
                        <li>Crie uma nova planilha no Google Sheets</li>
                        <li>Clique em "Compartilhar" e defina como "Qualquer pessoa com o link pode editar"</li>
                        <li>Copie o ID da planilha da URL (exemplo: docs.google.com/spreadsheets/d/<strong>ID_AQUI</strong>/edit)</li>
                        <li>Cole o ID no campo abaixo</li>
                    </ol>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ID da Planilha Google Sheets</label>
                    <input type="text" id="sheetId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Cole o ID da planilha aqui">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Aba (Sheet)</label>
                    <input type="text" id="sheetName" value="Eventos" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="testarConexao()" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-all font-medium">
                        üîç Testar Conex√£o
                    </button>
                    <button onclick="salvarConfiguracao()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium">
                        üíæ Salvar e Sincronizar
                    </button>
                </div>

                <div id="statusConexao" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Filtros e A√ß√µes -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Biblioteca</label>
                    <select id="filtroBiblioteca" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Todas as Bibliotecas</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Evento</label>
                    <input type="text" id="campoBusca" placeholder="Digite o nome do evento..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="flex items-end">
                    <button onclick="abrirFormulario()" class="w-full gradient-button text-white px-4 py-2 rounded-lg transition-all font-medium">
                        ‚ûï Novo Evento
                    </button>
                </div>

                <div class="flex items-end">
                    <button onclick="abrirRelatorios()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all font-medium">
                        üìä Relat√≥rios
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Relat√≥rios -->
        <div id="modalRelatorios" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üìä Gerar Relat√≥rio</h2>
                    <button onclick="fecharRelatorios()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Biblioteca</label>
                        <select id="relBiblioteca" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas as Bibliotecas</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">M√™s/Ano</label>
                        <input type="month" id="relMes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="fecharRelatorios()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
                            Cancelar
                        </button>
                        <button onclick="gerarRelatorioPDF()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium">
                            Gerar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formul√°rio -->
        <div id="formularioEvento" class="bg-white rounded-lg shadow-lg p-6 mb-6 border-l-4 border-blue-600 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    üìÖ <span id="tituloFormulario">Cadastrar Novo Evento</span>
                </h2>
                <button onclick="fecharFormulario()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Biblioteca <span class="text-red-500">*</span></label>
                    <select id="biblioteca" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Evento <span class="text-red-500">*</span></label>
                    <input type="text" id="nomeEvento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome do evento" required>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subt√≠tulo do Evento (opcional)</label>
                    <input type="text" id="subtitulo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite o subt√≠tulo">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Linguagem Cultural <span class="text-red-500">*</span></label>
                    <select id="linguagemCultural" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Classifica√ß√£o Et√°ria</label>
                    <select id="classificacaoEtaria" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o do Evento</label>
                    <textarea id="descricao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Descreva o evento..."></textarea>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link (opcional)</label>
                    <input type="url" id="link" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="https://">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data do Evento <span class="text-red-500">*</span></label>
                    <input type="date" id="dataInicial" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Frequ√™ncia do Evento</label>
                    <select id="frequencia" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hor√°rio de In√≠cio</label>
                    <input type="time" id="horarioInicio" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hor√°rio de Fim</label>
                    <input type="time" id="horarioFim" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="md:col-span-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="temParceria" class="checkbox-custom" onchange="toggleParceria()">
                        <span class="text-sm font-medium text-gray-700">Este evento possui alguma Parceria?</span>
                    </label>
                </div>

                <div id="campoParceria" class="md:col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Parceria</label>
                    <select id="tipoParceria" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o tipo de parceria</option>
                        <option value="CCBEU">CCBEU</option>
                        <option value="ProAC">ProAC</option>
                        <option value="Voluntariado">Voluntariado</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Total de P√∫blico (opcional)</label>
                    <input type="number" id="totalPublico" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: 50">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone para Informa√ß√µes (opcional)</label>
                    <input type="tel" id="telefone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="(11) 1234-5678">
                </div>
            
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Acessibilidade - Libras</label>
                    <select id="libras" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="N√£o">N√£o</option>
                        <option value="Sim">Sim</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Acessibilidade - √Åudio Descri√ß√£o</label>
                    <select id="audioDescricao" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="N√£o">N√£o</option>
                        <option value="Sim">Sim</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tags do Evento (separadas por v√≠rgula)</label>
                    <input type="text" id="tags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: literatura, infantil, conta√ß√£o de hist√≥rias">
                </div>
            </div>

            <div class="mt-6 flex gap-3 justify-end">
                <button onclick="fecharFormulario()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">Cancelar</button>
                <button onclick="salvarEvento()" class="px-6 py-2 gradient-button text-white rounded-lg transition-all font-medium">
                    <span id="btnSalvarTexto">Cadastrar Evento</span>
                </button>
            </div>
        </div>

        <!-- Lista de Eventos -->
        <div>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">
                    üìö Eventos Cadastrados <span id="contadorEventos" class="text-lg text-gray-500 font-normal">(0)</span>
                </h2>
            </div>
            <div id="listaEventos"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Google Sheets
        let sheetsConfig = {
            sheetId: localStorage.getItem('sheets-config-id') || '',
            sheetName: localStorage.getItem('sheets-config-name') || 'Eventos',
            imageUrl: 'https://i.imgur.com/yourimageurl.png' // Altere para a URL da sua imagem
        };

        // Dados do sistema
        const bibliotecas = [
            'Biblioteca de Arte Ilva Aceto Maranesi',
            'Biblioteca Erico Ver√≠ssimo',
            'Biblioteca Guimar√£es Rosa',
            'Biblioteca Machado de Assis',
            'Biblioteca Malba Tahan',
            'Biblioteca Manuel Bandeira',
            'Biblioteca Monteiro Lobato',
            'Espalhando √† Leitura',
            'Gibiteca Eug√™nio Colonnese',
            'Troca Livro'
        ];

        const linguagensCulturais = [
            'Artes Circenses', 'Artes Integradas', 'Artes Visuais', 'Audiovisual', 'Cinema',
            'Cultura Digital', 'Cultura Ind√≠gena', 'Cultura Tradicional', 'Curso ou Oficina',
            'Dan√ßa', 'Exposi√ß√£o', 'Hip Hop', 'Livro e Literatura', 'M√∫sica Erudita',
            'M√∫sica Popular', 'Outros', 'Palestra, Debate ou Encontro', 'R√°dio', 'Teatro'
        ];

        const classificacoesEtarias = ['Livre', '10 anos', '12 anos', '14 anos', '16 anos', '18 anos'];
        const frequencias = ['Uma vez', 'Semanal', 'Todos os dias'];

        let eventos = [];
        let eventoEditandoId = null;

        // Carregar logo no header
        function carregarLogo() {
            const logo = document.getElementById('logoHeader');
            logo.src = sheetsConfig.imageUrl;
            logo.style.display = 'block';
            logo.onerror = () => { logo.style.display = 'none'; };
        }

        // Fun√ß√µes do Google Sheets
        function abrirConfiguracao() {
            document.getElementById('modalConfiguracao').style.display = 'flex';
            document.getElementById('sheetId').value = sheetsConfig.sheetId;
            document.getElementById('sheetName').value = sheetsConfig.sheetName;
        }

        function fecharConfiguracao() {
            document.getElementById('modalConfiguracao').style.display = 'none';
            document.getElementById('statusConexao').classList.add('hidden');
        }

        function mostrarStatus(mensagem, tipo) {
            const status = document.getElementById('statusConexao');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800');
            
            if (tipo === 'sucesso') {
                status.classList.add('bg-green-100', 'text-green-800');
            } else {
                status.classList.add('bg-red-100', 'text-red-800');
            }
            
            status.textContent = mensagem;
        }

        async function testarConexao() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();

            if (!sheetId) {
                mostrarStatus('‚ùå Por favor, insira o ID da planilha', 'erro');
                return;
            }

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Erro na conex√£o');
                
                mostrarStatus('‚úÖ Conex√£o bem-sucedida! A planilha est√° acess√≠vel.', 'sucesso');
            } catch (error) {
                mostrarStatus('‚ùå Erro: Verifique se o ID est√° correto e se a planilha est√° p√∫blica para edi√ß√£o', 'erro');
            }
        }

        function salvarConfiguracao() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim();

            if (!sheetId) {
                mostrarStatus('‚ùå Por favor, insira o ID da planilha', 'erro');
                return;
            }

            sheetsConfig.sheetId = sheetId;
            sheetsConfig.sheetName = sheetName;
            
            localStorage.setItem('sheets-config-id', sheetId);
            localStorage.setItem('sheets-config-name', sheetName);

            sincronizarComSheets();
            fecharConfiguracao();
            alert('‚úÖ Configura√ß√£o salva! Os dados ser√£o sincronizados com o Google Sheets.');
        }

        async function sincronizarComSheets() {
            if (!sheetsConfig.sheetId) {
                console.log('Google Sheets n√£o configurado');
                return;
            }

            try {
                await carregarDeSheets();
                await salvarEmSheets();
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
            }
        }

        async function carregarDeSheets() {
            if (!sheetsConfig.sheetId) return;

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetsConfig.sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetsConfig.sheetName)}`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));

                if (json.table.rows.length > 1) {
                    eventos = json.table.rows.slice(1).map(row => {
                        const cols = row.c;
                        return {
                            id: cols[0]?.v || Date.now().toString(),
                            biblioteca: cols[1]?.v || '',
                            nomeEvento: cols[2]?.v || '',
                            subtitulo: cols[3]?.v || '',
                            linguagemCultural: cols[4]?.v || '',
                            descricao: cols[5]?.v || '',
                            classificacaoEtaria: cols[6]?.v || 'Livre',
                            link: cols[7]?.v || '',
                            dataInicial: cols[8]?.v || '',
                            horarioInicio: cols[9]?.v || '',
                            horarioFim: cols[10]?.v || '',
                            frequencia: cols[11]?.v || 'Uma vez',
                            temParceria: cols[12]?.v === 'true',
                            tipoParceria: cols[13]?.v || '',
                            totalPublico: cols[14]?.v || '',
                            telefone: cols[15]?.v || '',
                            libras: cols[16]?.v || 'N√£o',
                            audioDescricao: cols[17]?.v || 'N√£o',
                            tags: cols[18]?.v || '',
                            dataCriacao: cols[19]?.v || new Date().toISOString()
                        };
                    });
                    renderizarEventos();
                }
            } catch (error) {
                console.error('Erro ao carregar do Sheets:', error);
            }
        }

        async function salvarEmSheets() {
            if (!sheetsConfig.sheetId || eventos.length === 0) return;

            const cabecalho = [
                'ID', 'Biblioteca', 'Nome do Evento', 'Subt√≠tulo', 'Linguagem Cultural',
                'Descri√ß√£o', 'Classifica√ß√£o Et√°ria', 'Link', 'Data', 'Hor√°rio In√≠cio',
                'Hor√°rio Fim', 'Frequ√™ncia', 'Tem Parceria', 'Tipo Parceria',
                'Total P√∫blico', 'Telefone', 'Libras', '√Åudio Descri√ß√£o', 'Tags', 'Data Cria√ß√£o'
            ];

            const linhas = eventos.map(e => [
                e.id, e.biblioteca, e.nomeEvento, e.subtitulo, e.linguagemCultural,
                e.descricao, e.classificacaoEtaria, e.link, e.dataInicial, e.horarioInicio,
                e.horarioFim, e.frequencia, e.temParceria.toString(), e.tipoParceria,
                e.totalPublico, e.telefone, e.libras, e.audioDescricao, e.tags, e.dataCriacao
            ]);

            const dados = [cabecalho, ...linhas];
            
            console.log('Dados salvos localmente. Para salvar no Sheets, use Google Apps Script ou API.');
        }

        function toggleParceria() {
            const checkbox = document.getElementById('temParceria');
            const campo = document.getElementById('campoParceria');
            if (checkbox.checked) {
                campo.classList.remove('hidden');
            } else {
                campo.classList.add('hidden');
                document.getElementById('tipoParceria').value = '';
            }
        }

        function abrirRelatorios() {
            document.getElementById('modalRelatorios').style.display = 'flex';
            const hoje = new Date();
            const mesAtual = hoje.toISOString().substr(0, 7);
            document.getElementById('relMes').value = mesAtual;
        }

        function fecharRelatorios() {
            document.getElementById('modalRelatorios').style.display = 'none';
        }

        function gerarRelatorioPDF() {
            const biblioteca = document.getElementById('relBiblioteca').value;
            const mesAno = document.getElementById('relMes').value;

            if (!mesAno) {
                alert('Por favor, selecione o m√™s/ano para o relat√≥rio');
                return;
            }

            const [ano, mes] = mesAno.split('-');
            const mesesNome = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            const eventosFiltrados = eventos.filter(evento => {
                const dataEvento = new Date(evento.dataInicial + 'T00:00');
                const matchBiblioteca = !biblioteca || evento.biblioteca === biblioteca;
                const matchMes = dataEvento.getFullYear() === parseInt(ano) && 
                                 (dataEvento.getMonth() + 1) === parseInt(mes);
                return matchBiblioteca && matchMes;
